set -e
#set -x

while getopts p:D name; do
  case "$name" in
    D)
        IS_DEBUG='true'
        ;;
    p)
        path="${OPTARG?}"
        ;;
  esac
done

if [ -z "${path}" ]; then
  path=/puppetlabs/enterprise-dist/dists
fi

build_dir=($(find "${path?}" -type d -name 'puppet-enterprise*'))
if [ -z "${build_dir[0]}" ]; then
  ls -d "${path?}"
  echo "** No installer directory found in ${path?}."
  exit 1
elif [[ ${#build_dir[@]} -gt 1 ]]; then
  ls -d "${path?}"
  echo "** Multiple installer directories in ${path?}.  You will need to specify one."
  exit 1
fi

if [ -f /vagrant/hieradata/common.conf ]; then
  conf_file=/vagrant/hieradata/common.conf
else
  conf_file=conf.d/common.conf
fi

if [ -f /vagrant/hieradata/common.yaml ]; then
  production_hieradata=/etc/puppetlabs/code/environments/production/hieradata
  mkdir -p $production_hieradata
  cp /vagrant/hieradata/common.yaml $production_hieradata
fi

host=$(hostname -s)

pushd "${build_dir?}"
  # Add Frankenbuilder signing key if present
  #
  frankenbuilder_key=packages/GPG-KEY-frankenbuilder.pub
  if [ -f "${frankenbuilder_key?}" ]; then
    if [ -f /etc/redhat-release  ]; then
      echo -e '      file:///opt/puppetlabs/server/data/packages/GPG-KEY-frankenbuilder' >> /etc/yum.repos.d/puppet_enterprise.repo
      rpm --import "${frankenbuilder_key?}"
    elif [ -f /etc/SuSE-release ]; then
      rpm --import "${frankenbuilder_key?}"
    else
      # Ubuntu
      apt-key add "${frankenbuilder_key?}"
    fi
  fi
  build=$(basename "${build_dir?}")
  [ "${IS_DEBUG}" = "true" ] && debug_flag='-D'
  time ./puppet-enterprise-installer -c "${conf_file}" "${debug_flag}" 2>&1 | tee "/vagrant/install-pem-${host}-${build?}.log"
  echo "** Installer exited with code: ${PIPESTATUS[0]}"
popd
